/*
=============================================================
Create Database and Schemas
=============================================================
Script Purpose:
    This script creates a new database named 'DataWarehouse' after checking if it already exists. 
    If the database exists, it is dropped and recreated. Additionally, the script sets up three schemas 
    within the database: 'bronze', 'silver', and 'gold'.
	
WARNING:
    Running this script will drop the entire 'DataWarehouse' database if it exists. 
    All data in the database will be permanently deleted. Proceed with caution 
    and ensure you have proper backups before running this script.
*/

USE master;
GO

-- Drop and recreate the 'DataWarehouse' database
IF EXISTS (SELECT 1 FROM sys.databases WHERE name = 'DataWarehouse')
BEGIN
    ALTER DATABASE DataWarehouse SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
    DROP DATABASE DataWarehouse;
END;
GO

-- Create the 'DataWarehouse' database
CREATE DATABASE DataWarehouse;
GO

USE DataWarehouse;
GO

-- Create Schemas
CREATE SCHEMA bronze;
GO

CREATE SCHEMA silver;
GO

CREATE SCHEMA gold;
GO;


--DDL DEFINITIONS OF THE TABLES

  IF OBJECT_ID ('bronze.crm_cust_info','U') IS NOT NULL
      DROP TABLE bronze.crm_cust_info;
CREATE TABLE bronze.crm_cust_info(
cst_id INT,
cst_key NVARCHAR (50) ,
cst_firstname NVARCHAR (50),
cst_lastname NVARCHAR (50),
cst_material_status NVARCHAR (50),
cst_gndr NVARCHAR (50),
cst_creat_date  DATE );

IF OBJECT_ID ('bronze.crm_prd_infr','U') IS NOT NULL
       DROP TABLE bronze.crm_prd_infr;
CREATE TABLE bronze.crm_prd_infr(
pro_id INT,
pro_key NVARCHAR (50),
pro_nm NVARCHAR (50),
pro_cost INT,
pro_line NVARCHAR (50),
pro_start_dt DATETIME,
pro_end_dt DATETIME);

IF OBJECT_ID ('bronze.crm_sales_details','U') IS NOT NULL
       DROP TABLE bronze.crm_sales_details;
CREATE TABLE bronze.crm_sales_details(
sis_ord_num NVARCHAR (50),
sis_prd_key NVARCHAR (50),
sis_cust_id INT,
sis_order_id INT,
sis_ship_dt INT,
sis_due_dt INT,
sis_sales INT,
sis_quantity INT,
sis_price INT);

IF OBJECT_ID ('bronze.erp_loc_a101','U') IS NOT NULL
       DROP TABLE bronze.erp_loc_a101;
CREATE TABLE bronze.erp_loc_a101(
 cis NVARCHAR (50),
 cuntry NVARCHAR (50));
 
 
 IF OBJECT_ID ('bronze.erp_cust_az12','U') IS NOT NULL
       DROP TABLE bronze.erp_cust_az12;
CREATE TABLE bronze.erp_cust_az12(
cid NVARCHAR (50),
bdate DATE,
gen NVARCHAR (50));


IF OBJECT_ID ('bronze.erp_px_cat_g1v2', 'U') IS NOT NULL
       DROP TABLE bronze.erp_px_cat_g1v2;
CREATE TABLE bronze.erp_px_cat_g1v2(
id NVARCHAR (50),
cat NVARCHAR (50),
subcat NVARCHAR (50),
maintenance NVARCHAR (50));


--DATA LODING TO TABLES

BULK INSERT [bronze].[crm_cust_info]
FROM 'C:\sql-datawarehouse-csv\sql-data-warehouse-project\datasets\source_crm\cust_info.csv'
with (
firstrow = 2,
FIELDTERMINATOR = ',',
TABLOCK);


GO
